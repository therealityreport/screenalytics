# Screenalytics API - nginx reverse proxy configuration
#
# This config proxies HTTPS traffic to the FastAPI backend running on localhost:8000.
# It includes settings optimized for Server-Sent Events (SSE) streaming.
#
# Installation:
#   1. Copy to /etc/nginx/sites-available/screenalytics-api
#   2. Create symlink: sudo ln -s /etc/nginx/sites-available/screenalytics-api /etc/nginx/sites-enabled/
#   3. Replace 'api.example.com' with your actual domain
#   4. Run certbot to add TLS: sudo certbot --nginx -d api.example.com
#   5. Test config: sudo nginx -t
#   6. Reload nginx: sudo systemctl reload nginx
#
# See: docs/infra/screenalytics_deploy_plan.md

# Rate limiting zone (optional, uncomment to enable)
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

upstream screenalytics_api {
    server 127.0.0.1:8000;
    keepalive 32;
}

server {
    # Replace with your actual domain
    server_name api.example.com;

    # Logging
    access_log /var/log/nginx/screenalytics-api.access.log;
    error_log /var/log/nginx/screenalytics-api.error.log;

    # Request size limits (adjust for video upload if proxying uploads)
    client_max_body_size 100M;

    # Main API proxy
    location / {
        proxy_pass http://screenalytics_api;
        proxy_http_version 1.1;

        # Headers for proper forwarding
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # Connection keep-alive
        proxy_set_header Connection "";

        # SSE (Server-Sent Events) support
        # These settings are critical for real-time job progress streaming
        proxy_buffering off;
        proxy_cache off;

        # Long timeout for SSE connections (24 hours)
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;

        # Rate limiting (uncomment to enable)
        # limit_req zone=api_limit burst=20 nodelay;
    }

    # Health check endpoint (shorter timeout, can be cached)
    location /healthz {
        proxy_pass http://screenalytics_api/healthz;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 10s;

        # Allow caching for health checks
        proxy_cache_valid 200 5s;
    }

    # SSE events endpoint (explicit config for clarity)
    location ~ ^/episodes/.*/events$ {
        proxy_pass http://screenalytics_api;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # SSE-specific settings
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        # Very long timeout for SSE streams
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Celery job streaming endpoint
    location ~ ^/celery_jobs/stream/ {
        proxy_pass http://screenalytics_api;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # Streaming-specific settings
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Listen on port 80 (certbot will add HTTPS listener)
    listen 80;

    # TLS configuration will be added by certbot
    # After running: sudo certbot --nginx -d api.example.com
    # Certbot adds:
    #   listen 443 ssl;
    #   ssl_certificate /etc/letsencrypt/live/api.example.com/fullchain.pem;
    #   ssl_certificate_key /etc/letsencrypt/live/api.example.com/privkey.pem;
    #   include /etc/letsencrypt/options-ssl-nginx.conf;
    #   ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
