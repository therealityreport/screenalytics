name: on-push-doc-sync
on:
  push:
    branches: [main]
    paths:
      - "apps/**"
      - "workers/**"
      - "packages/**"
      - "db/**"
      - "config/**"
      - "FEATURES/**"
      - "agents/**"
      - "mcps/**"
      - "infra/**"
      - "tests/**"
      - "tools/**"
jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Compute changed files
        id: diff
        run: |
          git fetch --prune --unshallow || true
          echo "changed<<EOF" >> "$GITHUB_OUTPUT"
          git diff --name-only HEAD~1..HEAD >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Prepare changed_files JSON
        id: prep
        env:
          CHANGED: ${{ steps.diff.outputs.changed }}
        run: |
          python - <<'PY' > changed.json
          import os, json
          changed = os.environ.get('CHANGED', '')
          files = [p for p in (changed.splitlines()) if p.strip()]
          print(json.dumps(files))
          PY
          echo "changed_json<<EOF" >> "$GITHUB_OUTPUT"
          cat changed.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run Codex playbook (update-docs-on-change)
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          codex-args: |
            [
              "exec",
              "--config","./config/codex.config.toml",
              "--playbook","./agents/playbooks/update-docs-on-change.yaml",
              "--input.changed_files","${{ steps.prep.outputs.changed_json }}"
            ]
