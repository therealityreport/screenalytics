name: on-push-doc-sync
on:
  push:
    branches: [main]
    paths:
      - "apps/**"
      - "workers/**"
      - "packages/**"
      - "db/**"
      - "config/**"
      - "FEATURES/**"
      - "agents/**"
      - "mcps/**"
      - "infra/**"
      - "tests/**"
      - "tools/**"
jobs:
  sync-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute changed files
        id: diff
        run: |
          git fetch --prune --unshallow || true
          echo "changed<<EOF" >> "$GITHUB_OUTPUT"
          git diff --name-only HEAD~1..HEAD >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Run Codex playbook (update-docs-on-change)
        uses: openai/codex-action@v1
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          args: >
            exec
            --config ./config/codex.config.toml
            --playbook ./agents/playbooks/update-docs-on-change.yaml
            --input.changed_files "${{ steps.diff.outputs.changed }}"
