name: feature-promote
on:
  pull_request:
    paths-ignore: ["**/*.md"]
jobs:
  enforce-promotion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Block imports from FEATURES/**
        run: |
          if grep -R --include='*.py' -n 'from FEATURES' || grep -R --include='*.py' -n 'import FEATURES'; then
            echo "Imports from FEATURES forbidden"
            exit 1
          fi

      - name: TTL check for features
        run: |
          python - <<'PY'
          import pathlib, sys, time
          root = pathlib.Path("FEATURES")
          if not root.exists():
            sys.exit(0)
          now = time.time()
          bad = []
          for feature_dir in root.iterdir():
            if not feature_dir.is_dir():
              continue
            age_days = (now - feature_dir.stat().st_mtime) / (60*60*24)
            if age_days > 30:
                bad.append(f"{feature_dir} older than 30 days")
          if bad:
            print("\n".join(bad))
            sys.exit(1)
          print("TTL ok")
          PY

      - name: Block root docs unless promoting
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PROMOTION_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'promotion') }}
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          if git diff --name-only "$BASE_SHA"...HEAD | grep -q '^docs/.*\.md$'; then
            if [ "$PROMOTION_LABEL" != "true" ]; then
              echo "Root docs edits require 'promotion' label"
              exit 1
            fi
          fi

      - name: Pre-commit
        run: |
          python -m pip install --upgrade pip
          python -m pip install pre-commit
          pre-commit run --all-files
