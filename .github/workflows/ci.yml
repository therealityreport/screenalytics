name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install ruff

      - name: Lint with ruff
        run: |
          ruff check --select=E9,F63,F7,F82 --target-version=py311 .

      - name: Compile critical modules
        run: |
          python -m py_compile apps/api/main.py apps/api/routers/*.py apps/api/services/*.py apps/api/tasks.py

  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov pyyaml numpy opencv-python-headless fastapi httpx requests pillow python-multipart reportlab

      - name: Run face_alignment tests
        run: |
          pytest FEATURES/face_alignment/tests/ -v --tb=short -m "not slow"

      - name: Run body_tracking tests
        run: |
          pytest FEATURES/body_tracking/tests/ -v --tb=short -m "not slow"

      - name: Run arcface_tensorrt tests
        run: |
          pytest FEATURES/arcface_tensorrt/tests/ -v --tb=short -m "not slow"

      - name: Run eval harness tests
        run: |
          pytest tools/experiments/tests/ -v --tb=short -m "not slow"

      - name: Run core unit tests
        run: |
          pytest -q \
            tests/unit/test_profiles_config_resolution.py \
            tests/unit/test_track_fusion_diagnostics.py \
            tests/unit/test_run_export_missing_artifacts_na.py \
            tests/unit/test_run_export_screentime_totals.py \
            tests/unit/test_gate_auto_rerun_reporting.py \
            tests/unit/test_run_export_db_optional.py \
            tests/api/test_episode_status.py \
            tests/api/test_screentime.py \
            tests/ml/test_sse_progress.py \
            --tb=short -m "not slow"

  smoke-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          pip install pyyaml numpy

      - name: Create required config files
        run: |
          mkdir -p config/pipeline
          touch config/pipeline/detection.yaml
          touch config/pipeline/tracking.yaml
          touch config/pipeline/embedding.yaml
          touch config/pipeline/face_alignment.yaml

      - name: Run smoke test (dry-run)
        run: |
          python -m tools.smoke.smoke_run --episode-id ci-test --dry-run -v

      - name: Upload smoke artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-artifacts
          path: |
            data/smoke/**/smoke_report.json
            data/smoke/**
            data/analytics/**/screentime.json
          if-no-files-found: ignore
